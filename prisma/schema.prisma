generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum InsightType {
  WEEKLY
  PATTERN
  PREDICTION
  CORRELATION
}

model User {
  id              String            @id @default(cuid())
  email           String            @unique
  name            String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  dailyLogs       DailyLog[]
  derivedMetrics  DerivedMetrics[]
  insights        Insight[]
  otps            OTP[]
}

model OTP {
  id        String   @id @default(cuid())
  userId    String
  code      String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, code, expiresAt])
}

model DailyLog {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime

  mood        Int?
  energy      Int?
  sleepHours  Float?
  workHours   Float?
  meetings    Int?
  gym         Boolean? @default(false)
  notes       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id])

  @@unique([userId, date])
  @@index([userId])
}

model DerivedMetrics {
  id            String   @id @default(cuid())
  userId        String
  periodStart   DateTime
  periodEnd     DateTime
  averages      Json
  deltas        Json
  correlations  Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, periodStart, periodEnd])
  @@index([userId, periodStart, periodEnd])
}

model Insight {
  id          String       @id @default(cuid())
  userId      String
  type        InsightType
  periodStart DateTime
  periodEnd   DateTime
  content     String
  confidence  Float
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, periodStart, periodEnd])
  @@index([userId, type])
}

model InsightEvent {
  id         String   @id @default(cuid())
  userId     String
  insightKey String   // stable key (title for now)
  scope      String   // weekly | monthly
  confidence Float
  type       String   // insight | prediction

  createdAt DateTime @default(now())

  @@index([userId, insightKey])
}

model InsightFeedback {
  id         String   @id @default(cuid())
  userId     String
  insightKey String
  action     String   // acknowledged | dismissed

  createdAt DateTime @default(now())

  @@unique([userId, insightKey])
}
